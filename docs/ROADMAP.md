# Roadmap разработки Event-Driven TODO Application

Этот документ описывает последовательный план разработки учебного проекта на Python (FastAPI + Kafka), построенного по event-driven архитектуре.

План задуман как учебный маршрут: каждый шаг логически опирается на предыдущий и формирует устойчивую архитектуру.

## Шаг 1. Bootstrap репозитория и стандартов проекта
**Цель:** создать профессиональный каркас проекта до начала кодинга.

**Подзадачи**
- Создать структуру каталогов:
  - `services/api`
  - `services/scheduler`
  - `services/mailer`
  - `frontend`
  - `infra`
  - `docs`
- Добавить `.gitignore`, `.editorconfig`.
- Создать `pyproject.toml` (ruff, mypy, pytest).
- Добавить `Makefile` с базовыми командами.
- Создать черновой `README.md`.

**Definition of Done**
- Репозиторий имеет понятную структуру.
- Есть единые правила стиля и инструментов.
- Проект выглядит “взросло” даже без логики.

## Шаг 2. Docker Compose: базовая инфраструктура
**Цель:** система должна подниматься целиком с самого начала.

**Подзадачи**
- Создать `docker-compose.yml`.
- Добавить сервисы:
  - postgres
  - kafka (+ zookeeper / kraft)
  - api (заглушка)
  - scheduler (заглушка)
  - mailer (заглушка)
  - nginx (frontend)
- Создать `.env.example`.

**Definition of Done**
- `docker compose up` запускает все контейнеры.
- Сервисы стартуют без бизнес-логики.

## Шаг 3. Проектирование БД и Alembic
**Цель:** зафиксировать source of truth системы.

**Подзадачи**
- Подключить Alembic в api.
- Описать модели:
  - User
  - Task
  - ProcessedEvent
- Добавить индексы `(user_id)` и `(user_id, done)`.
- Создать и применить первую миграцию.

**Definition of Done**
- База данных воспроизводится с нуля.
- Схема соответствует `TASK.md`.

## Шаг 4. Базовый FastAPI и конфигурация
**Цель:** заложить устойчивую платформу для API.

**Подзадачи**
- Создать FastAPI-приложение.
- Реализовать `/health`.
- Настроить конфигурацию через env.
- Настроить async DB session.
- Базовая структура модулей.

**Definition of Done**
- API стабильно стартует.
- Есть healthcheck.
- Подключение к БД работает.

## Шаг 5. Аутентификация и JWT
**Цель:** реализовать безопасный доступ к системе.

**Подзадачи**
- `POST /auth/register`.
- `POST /auth/login`.
- Хеширование паролей.
- Генерация JWT.
- Dependency `get_current_user`.

**Definition of Done**
- Пользователь может зарегистрироваться.
- Получить JWT.
- Использовать JWT для доступа к защищённым эндпоинтам.

## Шаг 6. CRUD задач (без Kafka)
**Цель:** реализовать основной пользовательский функционал.

**Подзадачи**
- `GET /tasks`.
- `POST /tasks`.
- `PATCH /tasks/{id}`.
- `DELETE /tasks/{id}`.
- Проверка принадлежности задачи пользователю.
- Корректная работа `done` / `done_at`.

**Definition of Done**
- TODO-приложение полностью работает.
- Все операции изолированы по пользователю.

## Шаг 7. Стандартизация доменных событий
**Цель:** формализовать event-driven слой.

**Подзадачи**
- Ввести event envelope:
  - `event_id`
  - `type`
  - `occurred_at`
  - `payload`
- Описать схемы:
  - `task.created`
  - `task.completed`
  - `email.daily_digest.requested`

**Definition of Done**
- Формат событий един и задокументирован.
- События готовы к публикации в Kafka.

## Шаг 8. Kafka в API: публикация событий
**Цель:** начать event-driven поведение API.

**Подзадачи**
- Подключить Kafka producer.
- Публиковать `task.created`.
- Публиковать `task.completed`.
- Структурное логирование событий.

**Definition of Done**
- Изменения состояния порождают события.
- Kafka реально используется, а не “для галочки”.

## Шаг 9. Outbox Pattern в API
**Цель:** гарантировать доставку событий.

**Подзадачи**
- Таблица `outbox_events`.
- Запись события в outbox в одной транзакции с бизнес-изменением.
- Publisher loop для Kafka.
- Обновление статуса события после публикации.

**Definition of Done**
- События не теряются при сбоях Kafka.
- Реализован production-паттерн.

## Шаг 10. Scheduler Service (cron)
**Цель:** реализовать офлайн-логику.

**Подзадачи**
- APScheduler с cron 00:00.
- Агрегация задач по пользователям.
- Формирование `DailyDigestRequested`.
- Публикация в Kafka.

**Definition of Done**
- Каждый день генерируются digest-события.
- Scheduler не отправляет email напрямую.

## Шаг 11. Mailer Service
**Цель:** обработка внешних эффектов.

**Подзадачи**
- Kafka consumer.
- Обработка `email.daily_digest.requested`.
- Jinja2 шаблоны писем.
- SMTP отправка (Mailjet).
- Commit offset после успеха.

**Definition of Done**
- Письма реально уходят.
- Mailer полностью асинхронен.

## Шаг 12. Идемпотентность Mailer
**Цель:** исключить дублирование писем.

**Подзадачи**
- Таблица `processed_events`.
- Проверка `event_id` перед отправкой.
- Уникальный индекс.
- Корректная работа при повторной доставке Kafka.

**Definition of Done**
- At-least-once delivery не приводит к дублям.

## Шаг 13. Frontend (Static SPA)
**Цель:** завершить пользовательский контур.

**Подзадачи**
- HTML/CSS интерфейс.
- JS логика (auth, tasks).
- Хранение JWT.
- Обработка ошибок.
- Nginx конфигурация.

**Definition of Done**
- Приложение работает как SPA.
- Не требуется Swagger для использования.

## Шаг 14. Тестирование
**Цель:** сделать проект устойчивым.

**Подзадачи**
- Unit-тесты доменной логики.
- API-тесты.
- Тесты идемпотентности Mailer.
- (Опционально) интеграционные тесты.

**Definition of Done**
- Критичная логика покрыта тестами.
- Регрессии ловятся автоматически.

## Шаг 15. Observability и healthchecks
**Цель:** понимать, что происходит в системе.

**Подзадачи**
- Структурные логи.
- Healthchecks сервисов.
- Ясные сообщения об ошибках.

**Definition of Done**
- Понятно, где и почему что-то сломалось.

## Шаг 16. Финальная полировка и документация
**Цель:** превратить проект в витрину портфолио.

**Подзадачи**
- Полный `README.md`.
- `docs/architecture.md`.
- `docs/events.md`.
- `docs/api.md`.
- Обновлённый Makefile.

**Definition of Done**
- Репозиторий можно показать на собеседовании.
- Архитектура легко объясняется словами.
