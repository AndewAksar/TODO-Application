name: todo-app

networks:
    todo_net:

volumes:
    postgres_data:
    kafka_data:
    zookeeper_data:

services:
    postgres:
        image: postgres:16-alpine
        environment:
            POSTGRES_DB: ${POSTGRES_DB:-todo}
            POSTGRES_USER: ${POSTGRES_USER:-todo}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-todo}
        ports:
            - "${POSTGRES_PORT:-5432}:5432"
        volumes:
            - postgres_data:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
            interval: 5s
            timeout: 3s
            retries: 20
        networks: [todo_net]

    zookeeper:
        image: confluentinc/cp-zookeeper:7.6.1
        environment:
            ZOOKEEPER_CLIENT_PORT: 2181
            ZOOKEEPER_TICK_TIME: 2000
        ports:
            - "2181:2181"
        volumes:
            - zookeeper_data:/var/lib/zookeeper
        healthcheck:
            test: ["CMD-SHELL", "echo srvr | nc -w 2 localhost 2181 | grep -q 'Mode:'"]
            interval: 5s
            timeout: 3s
            retries: 20
            start_period: 20s
        networks: [todo_net]

    kafka:
        image: confluentinc/cp-kafka:7.6.1
        depends_on:
            zookeeper:
                condition: service_healthy
        environment:
            KAFKA_BROKER_ID: 1
            KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181

            KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092

            KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
            KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
            KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
            KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
        ports:
            - "9092:9092"
        volumes:
            - kafka_data:/var/lib/kafka/data
        healthcheck:
            test: ["CMD-SHELL", "nc -z localhost 9092"]
            interval: 5s
            timeout: 3s
            retries: 30
        networks: [todo_net]

    api:
        build:
            context: ./services/api-gateway
            dockerfile: Dockerfile
        environment:
            DATABASE_URL: ${DATABASE_URL:-postgresql+asyncpg://todo:todo@postgres:5432/todo}
            KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
        depends_on:
            postgres:
                condition: service_healthy
            kafka:
                condition: service_healthy
        ports:
            - "8008:8000"
        healthcheck:
            test: ["CMD-SHELL", "curl -fs http://localhost:8000/health || exit 1"]
            interval: 5s
            timeout: 3s
            retries: 30
        networks: [todo_net]

    scheduler:
        build:
            context: ./services/scheduler-service
        environment:
            KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
        depends_on:
            kafka:
                condition: service_healthy
        networks: [todo_net]

    mailer:
        build:
            context: ./services/mailer-service
        environment:
            KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
        depends_on:
            kafka:
                condition: service_healthy
        networks:
            [todo_net]

    nginx:
        image: nginx:1.27-alpine
        depends_on:
            api:
                condition: service_healthy
        ports:
            - "8080:80"
        volumes:
            - ./frontend:/usr/share/nginx/html:ro
            - ./infra/nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
        networks:
            [todo_net]
