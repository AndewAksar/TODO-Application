name: docker-smoke

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  docker-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # На ubuntu-latest docker compose уже есть, но Buildx полезен для кеша
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Compose config (lint)
        run: docker compose config

      - name: Build images
        run: docker compose build

      - name: Up (detached)
        run: docker compose up -d

      - name: Wait for health
        shell: bash
        run: |
          set -euo pipefail

          # Сервисы, которые ДОЛЖНЫ стать healthy:
          REQUIRED=("postgres" "zookeeper" "kafka" "api")

          echo "Waiting for services to become healthy..."
          for i in {1..90}; do
            all_ok=1
            for svc in "${REQUIRED[@]}"; do
              # Получаем статус контейнера: running/healthy/unhealthy/exited
              status="$(docker compose ps --status=running --format json | jq -r ".[] | select(.Service==\"$svc\") | .Health" 2>/dev/null || true)"

              # jq может отсутствовать → fallback:
              if ! command -v jq >/dev/null 2>&1; then
                status="$(docker inspect -f '{{.State.Health.Status}}' "$(docker compose ps -q "$svc")" 2>/dev/null || true)"
              fi

              if [[ "$status" != "healthy" ]]; then
                all_ok=0
                echo "  - $svc: $status"
              fi
            done

            if [[ "$all_ok" == "1" ]]; then
              echo "All required services are healthy."
              break
            fi

            sleep 2
            if [[ "$i" == "90" ]]; then
              echo "Timed out waiting for health."
              docker compose ps
              docker compose logs --no-color --tail=200
              exit 1
            fi
          done

      - name: Smoke HTTP (api + nginx)
        run: |
          set -euo pipefail
          curl -fsS http://localhost:8008/health
          curl -fsS http://localhost:8080/ | head -n 20

      - name: Show compose ps
        if: always()
        run: docker compose ps

      - name: Logs on failure
        if: failure()
        run: docker compose logs --no-color --tail=300

      - name: Down
        if: always()
        run: docker compose down -v
